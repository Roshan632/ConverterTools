<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Converter Tools - Free Online PDF Utilities</title>
    <meta name="description" content="A suite of 23 free, secure, and fully functional online PDF tools. Merge, split, convert, and edit PDFs directly in your browser.">
    <meta name="keywords" content="PDF tools, merge PDF, split PDF, compress PDF, convert PDF, edit PDF, sign PDF, watermark PDF, PDF to Word, Word to PDF, OCR PDF">
    
    <!-- Placeholder for Google Search Console verification -->
    <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE_HERE">

    <style>
        /* --- DESIGN SYSTEM & THEME --- */
        :root {
            --primary-red: #e5322d;
            --header-height: 70px;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --border-radius: 8px;
            --ease-out-cubic: cubic-bezier(0.215, 0.610, 0.355, 1);
            --transition-speed: 0.3s;
        }
        
        [data-theme="light"] {
            --background-primary: #ffffff;
            --background-secondary: #f8f8fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e0e0e0;
            --shadow-color: var(--shadow-light);
            --modal-overlay-color: rgba(0, 0, 0, 0.6);
        }
        
        [data-theme="dark"] {
            --background-primary: #1a1a1a;
            --background-secondary: #242424;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #444;
            --shadow-color: var(--shadow-dark);
            --modal-overlay-color: rgba(0, 0, 0, 0.8);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color var(--transition-speed) var(--ease-out-cubic), color var(--transition-speed) var(--ease-out-cubic);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        h1, h2, h3 { font-weight: 600; }
        .btn {
            background-color: var(--primary-red);
            color: white; padding: 12px 25px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 1rem; font-weight: 500;
            transition: background-color var(--transition-speed) ease, opacity var(--transition-speed) ease;
        }
        .btn:disabled { background-color: #888; cursor: not-allowed; opacity: 0.6; }
        .btn:not(:disabled):hover { background-color: #c42a25; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reveal { opacity: 0; transform: translateY(20px); transition: opacity 0.6s var(--ease-out-cubic), transform 0.6s var(--ease-out-cubic); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        /* --- HEADER & NAVIGATION --- */
        .header {
            background-color: var(--background-primary);
            position: sticky; top: 0; width: 100%; z-index: 1000;
            height: var(--header-height); display: flex; align-items: center;
            transition: box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        .header.scrolled { box-shadow: 0 2px 10px var(--shadow-color); }
        .navbar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }
        .nav-menu { list-style: none; display: flex; gap: 30px; align-items: center; }
        .nav-link { text-decoration: none; color: var(--text-primary); font-weight: 500; transition: color var(--transition-speed) ease; }
        .nav-link:hover { color: var(--primary-red); }
        .hamburger { display: none; cursor: pointer; }
        .bar { display: block; width: 25px; height: 3px; margin: 5px auto; background-color: var(--text-primary); transition: all 0.3s ease-in-out; }

        /* --- THEME TOGGLE WITH ICONS --- */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 28px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 28px; }
        .slider:before {
            background-color: white; content: ""; height: 20px; width: 20px;
            left: 4px; position: absolute; bottom: 4px;
            transition: .4s var(--ease-out-cubic); border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-red); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider .icon {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px;
            transition: opacity 0.4s ease;
            background-size: contain; background-repeat: no-repeat;
        }
        .slider .sun {
            left: 6px; opacity: 1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='orange'%3E%3Cpath d='M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zM2 12c0 .55.45 1 1 1h2c.55 0 1-.45 1-1s-.45-1-1-1H3c-.55 0-1 .45-1 1zM11 2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1s1-.45 1-1V3c0-.55-.45-1-1-1zM18.36 5.64c-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41zM5.64 18.36c.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41zM20 12c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1h2c.55 0 1-.45 1-1zM13 20c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1s1-.45 1-1v-2zM15.54 15.54c.39.39 1.02.39 1.41 0l1.41 1.41c.39.39.39 1.02 0 1.41-.39.39-1.02-.39-1.41 0l-1.41-1.41c-.39-.39-.39-1.02 0-1.41zM8.46 8.46c-.39-.39-1.02-.39-1.41 0L5.64 7.05c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l1.41 1.41c.39.39.39 1.02 0 1.41z'/%3E%3C/svg%3E");
        }
        .slider .moon {
            right: 6px; opacity: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M11.5 2C6.81 2 3 6.81 3 11.5S6.81 21 11.5 21C16.19 21 20 16.19 20 11.5c0-.28-.02-.55-.05-.83C18.6 11.4 18 12.62 18 14c0 3.31-2.69 6-6 6-1.38 0-2.6-.46-3.67-1.25C8.94 19.5 9.94 20 11 20c4.41 0 8-3.59 8-8 0-1.06-.2-2.06-.57-3C17.42 8.42 14.65 6 11.5 6c-.34 0-.68.02-1.01.07C10.61 4.3 11 2.94 11 2h.5z'/%3E%3C/svg%3E");
        }
        input:checked + .slider .sun { opacity: 0; }
        input:checked + .slider .moon { opacity: 1; }

        /* --- HERO SECTION --- */
        .hero-section {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 400px; text-align: center; padding: 40px 20px;
            background: linear-gradient(180deg, var(--background-primary) 0%, var(--background-secondary) 100%);
        }
        .hero-section h1 { font-size: 3rem; margin-bottom: 1rem; max-width: 600px; }
        .hero-section p { font-size: 1.2rem; color: var(--text-secondary); max-width: 550px; }

        /* --- AD PLACEHOLDERS --- */
        .ad-placeholder {
            display: flex; justify-content: center; align-items: center;
            background-color: var(--background-secondary); color: var(--text-secondary);
            border: 2px dashed var(--border-color); font-size: 1rem; text-align: center;
        }
        .ad-placeholder-banner { width: 728px; height: 90px; margin: 20px auto; }
        .ad-placeholder-sidebar { width: 200px; height: 400px; }

        /* --- TOOLS SECTION --- */
        .tools-section { padding: 60px 0; background-color: var(--background-secondary); }
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .tool-card {
            background-color: var(--background-primary); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); padding: 20px; text-align: center;
            cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative; overflow: hidden;
        }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px var(--shadow-color); border-color: var(--primary-red); }
        .tool-card .icon { font-size: 3rem; color: var(--primary-red); margin-bottom: 15px; }
        .tool-card h3 { font-size: 1.2rem; margin-bottom: 10px; color: var(--text-primary); }
        .tool-card p { font-size: 0.9rem; color: var(--text-secondary); min-height: 50px; }
        .badge { position: absolute; top: 10px; right: -30px; background-color: var(--primary-red); color: white; padding: 2px 30px; font-size: 0.8rem; transform: rotate(45deg); }

        /* --- ARTICLE & FOOTER --- */
        .article-section { padding: 60px 0; background-color: var(--background-primary); }
        .article-section h2 { text-align: center; font-size: 2.5rem; margin-bottom: 40px; }
        .article-section h3 { font-size: 1.5rem; margin: 30px 0 15px; color: var(--primary-red); }
        .article-section p, .article-section ul { margin-bottom: 15px; color: var(--text-secondary); }
        .article-section ul { padding-left: 20px; }
        .footer { background-color: #2a2a2a; color: #ccc; padding: 60px 0 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; margin-bottom: 40px; }
        .footer-col h4 { color: #fff; margin-bottom: 15px; font-size: 1.1rem; }
        .footer-col p, .footer-col a { color: #ccc; text-decoration: none; margin-bottom: 10px; display: block; transition: color 0.3s ease; }
        .footer-col a:hover { color: var(--primary-red); }
        .footer-bottom { text-align: center; border-top: 1px solid #444; padding-top: 20px; font-size: 0.9rem; }

        /* --- MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay-color);
            display: none; justify-content: center; align-items: center;
            z-index: 2000; animation: fadeIn 0.3s ease;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--background-primary); border-radius: var(--border-radius);
            width: 90%; max-width: 800px; max-height: 90vh;
            display: flex; overflow: hidden; position: relative;
        }
        .modal-main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.8rem; }
        .modal-close { font-size: 2rem; cursor: pointer; border: none; background: none; color: var(--text-secondary); }
        .modal-sidebar { padding: 20px; border-left: 1px solid var(--border-color); display: flex; align-items: center; }
        .drop-zone {
            border: 2px dashed var(--border-color); border-radius: var(--border-radius);
            padding: 40px; text-align: center; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .drop-zone.dragover { background-color: var(--background-secondary); border-color: var(--primary-red); }
        .drop-zone-text { font-size: 1.1rem; color: var(--text-secondary); }
        .file-list { list-style: none; margin-top: 20px; }
        .file-list-item {
            display: flex; justify-content: space-between; align-items: center; padding: 10px;
            background-color: var(--background-secondary); border-radius: 4px; margin-bottom: 5px;
        }
        .remove-file-btn { background: none; border: none; color: var(--primary-red); cursor: pointer; font-size: 1.2rem; }
        .tool-options { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px; }
        .tool-options label { display: block; margin-bottom: 5px; font-weight: 500; }
        .tool-options input, .tool-options select, .tool-options textarea {
            width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;
            margin-bottom: 10px; background-color: var(--background-primary); color: var(--text-primary);
        }
        .process-btn-container { text-align: center; margin-top: 20px; }
        #output-area a {
            display: inline-block; margin: 5px; padding: 10px 15px;
            background-color: #28a745; color: white; text-decoration: none; border-radius: 4px;
        }

        /* --- LOADER --- */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay-color);
            display: none; justify-content: center; align-items: center;
            z-index: 3000; flex-direction: column;
        }
        .spinner {
            border: 8px solid var(--background-secondary); border-top: 8px solid var(--primary-red);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 20px; font-size: 1.2rem; color: var(--text-primary); text-align: center; }

        /* --- TOOL-SPECIFIC STYLES --- */
        #edit-canvas-container, #sign-canvas-container { border: 1px solid var(--border-color); margin-bottom: 10px; position: relative; max-width: 100%; overflow: auto; background-color: #fff; }
        #pdf-canvas { position: absolute; top: 0; left: 0; }
        #fabric-canvas { position: relative; z-index: 10; }
        #edit-controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        #page-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        #organize-pages-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .page-thumbnail { position: relative; border: 1px solid var(--border-color); cursor: grab; }
        .page-thumbnail canvas { width: 100%; height: auto; display: block; }
        .page-thumbnail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .page-thumbnail:hover .page-thumbnail-overlay { opacity: 1; }
        .page-thumbnail-actions button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .page-number { font-size: 0.9rem; margin-top: 5px; }
        [data-theme="dark"] #edit-canvas-container, [data-theme="dark"] #sign-canvas-container { background-color: #333; }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 992px) {
            .tools-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .footer-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .nav-menu { position: fixed; left: -100%; top: var(--header-height); flex-direction: column; background-color: var(--background-primary); width: 100%; height: calc(100vh - var(--header-height)); text-align: center; transition: 0.3s; gap: 20px; padding: 30px; }
            .nav-menu.active { left: 0; }
            .hamburger { display: block; z-index: 10; }
            .hamburger.active .bar:nth-child(2) { opacity: 0; }
            .hamburger.active .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .hamburger.active .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
            .hero-section h1 { font-size: 2.5rem; }
            .modal-content { flex-direction: column; }
            .modal-sidebar { display: none; }
            .ad-placeholder-banner { width: 90%; max-width: 320px; height: 50px; }
        }
        @media (max-width: 480px) {
            .tools-grid { grid-template-columns: 1fr; }
            .footer-grid { grid-template-columns: 1fr; }
            .hero-section h1 { font-size: 2rem; }
            .modal-main { padding: 15px; }
            .modal-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar container">
            <a href="#home" class="logo">Converter Tools</a>
            <ul class="nav-menu">
                <li><a href="#home" class="nav-link">Home</a></li>
                <li><a href="#all-tools" class="nav-link">All Tools</a></li>
                <li><a href="#about" class="nav-link">About Us</a></li>
                <li><a href="#contact" class="nav-link">Contact Us</a></li>
                <li class="theme-switch-wrapper">
                    <label class="theme-switch" for="theme-checkbox">
                        <input type="checkbox" id="theme-checkbox" />
                        <div class="slider">
                            <div class="icon sun"></div>
                            <div class="icon moon"></div>
                        </div>
                    </label>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <main>
        <section id="home" class="hero-section reveal">
            <h1>Every tool you need to work with PDFs in one place</h1>
            <p>Completely free, secure, and easy to use. Manage your PDF files directly in your browser without any software installation.</p>
        </section>

        <div class="ad-placeholder ad-placeholder-banner reveal">Advertisement (728x90)</div>

        <section id="all-tools" class="tools-section reveal">
            <div class="container">
                <h2 style="text-align:center; font-size: 2.5rem; margin-bottom: 40px;">Our PDF Tools</h2>
                <div id="tools-grid" class="tools-grid">
                    <!-- Tool cards will be dynamically generated by JavaScript -->
                </div>
            </div>
        </section>

        <section id="about" class="article-section reveal">
             <div class="container">
                <h2>About Converter Tools</h2>
                <p>Converter Tools was born out of a simple need: a secure, free, and comprehensive set of PDF utilities that works for everyone, everywhere. We believe that document management should be easy and accessible, not locked behind expensive software or risky server uploads. That's why our entire suite of tools runs directly in your browser, ensuring your files remain private and secure on your own device.</p>
                <h3>Why Are PDF Tools Essential?</h3>
                <p>The PDF (Portable Document Format) is the standard for sharing documents reliably. However, working with PDFs can be challenging. Common tasks require specialized tools. Our platform provides solutions for:</p>
                <ul>
                    <li><strong>Organization:</strong> Merge multiple PDFs into one cohesive document or split a large file into smaller, manageable parts.</li>
                    <li><strong>Optimization:</strong> Compress PDFs to reduce their file size for easy sharing via email or web.</li>
                    <li><strong>Conversion:</strong> Convert PDFs to and from other popular formats like Word, PowerPoint, Excel, and JPG images.</li>
                    <li><strong>Editing & Security:</strong> Add text, shapes, signatures, or watermarks to protect and annotate your documents. Rotate pages to fix orientation issues.</li>
                </ul>
            </div>
        </section>
    </main>

    <footer id="contact" class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>About Converter Tools</h4>
                    <p>Your one-stop solution for all PDF needs. Process files directly in your browser without uploading anything. Secure, free, and fast.</p>
                </div>
                <div class="footer-col">
                    <h4>Tools</h4>
                    <a href="#all-tools">Merge PDF</a>
                    <a href="#all-tools">Split PDF</a>
                    <a href="#all-tools">Compress PDF</a>
                    <a href="#all-tools">Convert PDF</a>
                </div>
                <div class="footer-col">
                    <h4>Company</h4>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#about">About Us</a>
                </div>
                <div class="footer-col">
                    <h4>Contact</h4>
                    <a href="mailto:contact@convertertools.com">contact@convertertools.com</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Converter Tools. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <div id="modal" class="modal">
        <div class="modal-content">
            <main class="modal-main">
                <header class="modal-header">
                    <h2 id="modal-title" class="modal-title">Tool Title</h2>
                    <button id="modal-close" class="modal-close">&times;</button>
                </header>
                <div id="drop-zone" class="drop-zone">
                    <p class="drop-zone-text">Drag & Drop file(s) here or click to select</p>
                    <input type="file" id="file-input" hidden>
                </div>
                <ul id="file-list" class="file-list"></ul>
                <div id="tool-options" class="tool-options" style="display: none;"></div>
                <div class="process-btn-container">
                    <button id="process-btn" class="btn" disabled>Process</button>
                </div>
                <div id="output-area"></div>
            </main>
            <aside class="modal-sidebar">
                <div class="ad-placeholder ad-placeholder-sidebar">Advertisement (200x400)</div>
            </aside>
        </div>
    </div>

    <div id="loader" class="loader" style="display: none;">
        <div class="spinner"></div>
        <p id="loader-text" class="loader-text">Processing...</p>
    </div>

    <!-- External libraries. -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Library Configuration ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js`;

        // --- DOM Elements ---
        const toolsGrid = document.getElementById('tools-grid');
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const toolOptionsContainer = document.getElementById('tool-options');
        const processBtn = document.getElementById('process-btn');
        const outputArea = document.getElementById('output-area');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const header = document.querySelector('.header');
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const themeToggle = document.getElementById('theme-checkbox');
        
        // --- State Variables ---
        let currentTool = null;
        let selectedFiles = [];
        let fabricCanvas = null;
        let pdfDoc = null;
        let currentPage = 1;
        let editStates = {};
        
        // --- Helper: Render PDF Page to Canvas ---
        async function renderPdfPageToCanvas(pdfDoc, pageNum, scale = 1.5) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            return canvas;
        }

        // --- THE 23 FULLY FUNCTIONAL TOOL DEFINITIONS ---
        const toolImplementations = {
            'compress-pdf': {
                title: 'Compress PDF',
                desc: 'Reduce the file size of your PDF.',
                icon: '📦',
                fileType: '.pdf',
                multiple: false,
                options: () => `<label for="compress-quality">Image Quality (lower is smaller):</label><input type="range" id="compress-quality" min="0.1" max="1.0" step="0.1" value="0.7">`,
                process: async (files, options) => {
                    showLoader('Loading PDF...');
                    const quality = parseFloat(options['compress-quality']);
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const newPdf = await PDFLib.PDFDocument.create();

                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        showLoader(`Processing page ${i}/${pdfDoc.numPages}...`);
                        const canvas = await renderPdfPageToCanvas(pdfDoc, i, 1.5);
                        const imageDataUrl = canvas.toDataURL('image/jpeg', quality);
                        const imageBytes = await fetch(imageDataUrl).then(res => res.arrayBuffer());
                        const jpegImage = await newPdf.embedJpg(imageBytes);
                        const newPage = newPdf.addPage([canvas.width, canvas.height]);
                        newPage.drawImage(jpegImage, { x: 0, y: 0, width: canvas.width, height: canvas.height });
                    }
                    const newPdfBytes = await newPdf.save();
                    createDownloadLink(newPdfBytes, 'compressed.pdf', 'application/pdf');
                }
            },
            'edit-pdf': {
                title: 'Edit PDF',
                desc: 'Add text, shapes, and drawings to a PDF.',
                icon: '✏️',
                fileType: '.pdf',
                multiple: false,
                options: () => `
                    <div id="edit-controls">
                        <button id="add-text-btn" class="btn">Add Text</button>
                        <button id="add-rect-btn" class="btn">Add Rectangle</button>
                        <button id="draw-mode-btn" class="btn">Draw</button>
                    </div>
                    <div id="edit-canvas-container"><canvas id="pdf-canvas"></canvas><canvas id="fabric-canvas"></canvas></div>
                    <div id="page-nav">
                        <button id="prev-page" class="btn">&lt; Prev</button>
                        <span id="page-num"></span>
                        <button id="next-page" class="btn">Next &gt;</button>
                    </div>`,
                onFileSelect: async (file) => {
                    try {
                        showLoader('Loading editor...');
                        const pdfBytes = await file.arrayBuffer();
                        pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                        currentPage = 1;
                        editStates = {};
                        await renderPdfPageForEditing(currentPage);
                    } catch (e) {
                        showError(e.message);
                    } finally { hideLoader(); }
                },
                process: async (files) => {
                    if (fabricCanvas) editStates[currentPage] = fabricCanvas.toObject();
                    const pdfToEdit = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
                    const pages = pdfToEdit.getPages();

                    const pagePromises = Object.keys(editStates).map(async (pageNumStr) => {
                        const pageNum = parseInt(pageNumStr);
                        const pageState = editStates[pageNum];
                        if (!pageState || pageState.objects.length === 0) return;

                        showLoader(`Applying edits to page ${pageNum}/${pages.length}...`);
                        const page = pages[pageNum - 1];
                        const { width, height } = page.getSize();
                        
                        const tempCanvasEl = document.createElement('canvas');
                        const tempFabricCanvas = new fabric.StaticCanvas(tempCanvasEl, { width, height });
                        return new Promise(resolve => {
                            tempFabricCanvas.loadFromJSON(pageState, async () => {
                                tempFabricCanvas.renderAll();
                                const overlayImageBytes = await fetch(tempFabricCanvas.toDataURL({ format: 'png' })).then(res => res.arrayBuffer());
                                const overlayImage = await pdfToEdit.embedPng(overlayImageBytes);
                                page.drawImage(overlayImage, { x: 0, y: 0, width, height });
                                resolve();
                            });
                        });
                    });

                    await Promise.all(pagePromises);
                    const editedPdfBytes = await pdfToEdit.save();
                    createDownloadLink(editedPdfBytes, 'edited.pdf', 'application/pdf');
                }
            },
            'excel-to-pdf': { 
                title: 'Excel to PDF', 
                desc: 'Convert Excel spreadsheets to PDF.', 
                icon: '📈', 
                fileType: '.xlsx,.xls', 
                multiple: false, 
                process: async (files) => {
                    showLoader('Reading Excel file...');
                    const data = await files[0].arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const html = XLSX.utils.sheet_to_html(worksheet);
                    
                    showLoader('Generating PDF...');
                    const element = document.createElement('div');
                    element.innerHTML = `<style>table{border-collapse:collapse;width:100%;} th,td{border:1px solid #ccc;padding:4px;}</style>${html}`;
                    document.body.appendChild(element);
                    await html2pdf().set({jsPDF: {orientation: 'landscape'}, filename: 'excel.pdf'}).from(element).save();
                    document.body.removeChild(element);
                    hideLoader();
                }
            },
            'flatten-pdf': { 
                title: 'Flatten PDF', 
                desc: 'Make form fields & annotations non-editable.', 
                icon: '📜', 
                fileType: '.pdf', 
                multiple: false,
                process: async (files) => {
                    showLoader('Loading PDF...');
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const newPdf = await PDFLib.PDFDocument.create();

                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        showLoader(`Flattening page ${i}/${pdfDoc.numPages}...`);
                        const canvas = await renderPdfPageToCanvas(pdfDoc, i, 2);
                        const imageDataUrl = canvas.toDataURL('image/png');
                        const imageBytes = await fetch(imageDataUrl).then(res => res.arrayBuffer());
                        const pngImage = await newPdf.embedPng(imageBytes);
                        const newPage = newPdf.addPage([canvas.width, canvas.height]);
                        newPage.drawImage(pngImage, { x: 0, y: 0, width: canvas.width, height: canvas.height });
                    }
                    const newPdfBytes = await newPdf.save();
                    createDownloadLink(newPdfBytes, 'flattened.pdf', 'application/pdf');
                }
            },
            'gif-to-pdf': { 
                title: 'GIF to PDF', 
                desc: 'Convert the first frame of a GIF to a PDF.', 
                icon: '🎞️', 
                fileType: '.gif', 
                multiple: false,
                process: async (files) => {
                    showLoader('Processing GIF...');
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(files[0]);
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                    });
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    const pngDataUrl = canvas.toDataURL('image/png');
                    URL.revokeObjectURL(img.src);

                    const pdf = await PDFLib.PDFDocument.create();
                    const image = await pdf.embedPng(pngDataUrl);
                    const page = pdf.addPage([image.width, image.height]);
                    page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                    const pdfBytes = await pdf.save();
                    createDownloadLink(pdfBytes, 'from_gif.pdf', 'application/pdf');
                }
            },
            'html-to-pdf': { 
                title: 'HTML to PDF', 
                desc: 'Convert HTML code or files to PDF.', 
                icon: '🌐', 
                fileType: '.html,.htm', 
                multiple: false,
                options: () => `<label for="html-code">Paste HTML Code (or drop a file):</label><textarea id="html-code" rows="10"></textarea>`,
                process: async (files, options) => {
                    let htmlContent = options['html-code'];
                    if (files.length > 0) {
                        showLoader('Reading HTML file...');
                        htmlContent = await files[0].text();
                    }
                    if (!htmlContent) throw new Error('No HTML content provided.');
                    showLoader('Generating PDF...');
                    const element = document.createElement('div');
                    element.innerHTML = htmlContent;
                    document.body.appendChild(element);
                    await html2pdf().set({filename: 'from_html.pdf'}).from(element).save();
                    document.body.removeChild(element);
                    hideLoader();
                }
            },
            'jpg-to-pdf': { 
                title: 'JPG to PDF', 
                desc: 'Convert JPG images to a PDF file.', 
                icon: '🖼️', 
                fileType: '.jpg,.jpeg', 
                multiple: true, 
                process: async (files) => {
                    const pdf = await PDFLib.PDFDocument.create();
                    for (const [i, file] of files.entries()) {
                        showLoader(`Adding image ${i+1}/${files.length}...`);
                        const imgBytes = await file.arrayBuffer();
                        const image = await pdf.embedJpg(imgBytes);
                        const page = pdf.addPage([image.width, image.height]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                    }
                    const pdfBytes = await pdf.save();
                    createDownloadLink(pdfBytes, 'from_jpg.pdf', 'application/pdf');
                } 
            },
            'merge-pdf': {
                title: 'Merge PDF',
                desc: 'Combine multiple PDFs into a single document.',
                icon: '⧉',
                fileType: '.pdf',
                multiple: true,
                process: async (files) => {
                    const mergedPdf = await PDFLib.PDFDocument.create();
                    for (const [i, file] of files.entries()) {
                        showLoader(`Merging file ${i+1}/${files.length}...`);
                        const pdfBytes = await file.arrayBuffer();
                        const pdf = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    createDownloadLink(mergedPdfBytes, 'merged.pdf', 'application/pdf');
                }
            },
            'ocr-pdf': { 
                title: 'OCR PDF', 
                desc: 'Make scanned PDFs searchable (can be slow).', 
                icon: '🔍', 
                fileType: '.pdf', 
                multiple: false,
                process: async (files) => {
                    let worker = null;
                    try {
                        worker = await Tesseract.createWorker('eng', 1, {
                            logger: m => showLoader(`${m.status.replace(/_/g, ' ')}...<br>(${(m.progress * 100).toFixed(0)}%)`),
                        });
                        const result = await worker.recognize(files[0], {}, { pdf: true, pdfTitle: 'OCRed PDF' });
                        if (result && result.data && result.data.pdf) {
                             const pdfBytes = new Uint8Array(result.data.pdf);
                             createDownloadLink(pdfBytes, 'ocr_result.pdf', 'application/pdf');
                        } else {
                            console.error("OCR process did not return a PDF.", result);
                            throw new Error("The OCR process completed, but failed to generate a PDF. The file might be corrupted or unsupported.");
                        }
                    } catch (err) {
                        console.error("OCR process failed:", err);
                        throw new Error("An unexpected error occurred during the OCR process. Please try again.");
                    } finally {
                        if (worker) await worker.terminate();
                    }
                }
            },
            'organize-pdf': { 
                title: 'Organize PDF', 
                desc: 'Reorder, rotate, or delete PDF pages.', 
                icon: '🗂️', 
                fileType: '.pdf', 
                multiple: false, 
                options: () => `<p>Drag and drop pages to reorder.</p><div id="organize-pages-container"></div>`,
                onFileSelect: async (file) => {
                    try {
                        showLoader('Loading pages...');
                        const container = document.getElementById('organize-pages-container');
                        container.innerHTML = '';
                        const pdfBytes = await file.arrayBuffer();
                        pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                        for (let i = 1; i <= pdfDoc.numPages; i++) {
                            const canvas = await renderPdfPageToCanvas(pdfDoc, i, 0.3);
                            const pageDiv = document.createElement('div');
                            pageDiv.className = 'page-thumbnail';
                            pageDiv.dataset.originalIndex = i - 1;
                            pageDiv.draggable = true;
                            pageDiv.innerHTML = `<canvas width="${canvas.width}" height="${canvas.height}"></canvas><div class="page-thumbnail-overlay"><div class="page-thumbnail-actions"><button title="Rotate" onclick="window.rotatePageThumbnail(this)">🔄</button><button title="Delete" onclick="window.deletePageThumbnail(this)">🗑️</button></div><div class="page-number">${i}</div></div>`;
                            pageDiv.querySelector('canvas').getContext('2d').drawImage(canvas, 0, 0);
                            container.appendChild(pageDiv);
                        }
                    } catch(e) { showError(e.message); } finally { hideLoader(); }
                },
                process: async (files) => {
                    const container = document.getElementById('organize-pages-container');
                    const pageElements = Array.from(container.children);
                    if (pageElements.length === 0) throw new Error("No pages left to save.");
                    const originalPdf = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
                    const newPdf = await PDFLib.PDFDocument.create();
                    
                    const pageIndices = pageElements.map(p => parseInt(p.dataset.originalIndex)).filter(index => !isNaN(index));
                    const copiedPages = await newPdf.copyPages(originalPdf, pageIndices);

                    copiedPages.forEach((page, i) => {
                        const newPage = newPdf.addPage(page);
                        const rotation = parseInt(pageElements[i].dataset.rotation || '0');
                        newPage.setRotation(PDFLib.degrees(rotation));
                    });

                    const newPdfBytes = await newPdf.save();
                    createDownloadLink(newPdfBytes, 'organized.pdf', 'application/pdf');
                }
            },
            'page-numbers': { 
                title: 'Page Numbers', 
                desc: 'Add page numbers to a PDF file.', 
                icon: '#️⃣', 
                fileType: '.pdf', 
                multiple: false,
                options: () => `
                    <label for="page-num-position">Position:</label>
                    <select id="page-num-position">
                        <option value="bottom-center">Bottom Center</option>
                        <option value="bottom-right">Bottom Right</option>
                        <option value="top-center">Top Center</option>
                        <option value="top-right">Top Right</option>
                    </select>`,
                process: async (files, options) => {
                    const position = options['page-num-position'];
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                    const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
                    const pages = pdf.getPages();
                    for (const [i, page] of pages.entries()) {
                        const { width, height } = page.getSize();
                        const pageNumText = `${i + 1} / ${pages.length}`;
                        const textSize = 12;
                        const textWidth = font.widthOfTextAtSize(pageNumText, textSize);

                        let x, y;
                        if (position.includes('bottom')) y = 20; else y = height - 30;
                        if (position.includes('center')) x = width / 2 - textWidth / 2; else x = width - textWidth - 30;

                        page.drawText(pageNumText, { x, y, font, size: textSize, color: PDFLib.rgb(0, 0, 0) });
                    }
                    const newBytes = await pdf.save();
                    createDownloadLink(newBytes, 'numbered.pdf', 'application/pdf');
                }
            },
            'pdf-to-excel': { 
                title: 'PDF to Excel (CSV)', 
                desc: 'Extract text from PDF into a CSV file for Excel.', 
                icon: '📈', 
                fileType: '.pdf', 
                multiple: false, 
                process: async (files) => {
                    let csvContent = "";
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        showLoader(`Extracting data from page ${i}/${pdf.numPages}...`);
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        csvContent += textContent.items.map(item => `"${item.str.replace(/"/g, '""')}"`).join(',') + '\r\n';
                    }
                    createDownloadLink(new Blob([csvContent], {type: 'text/csv;charset=utf-8;'}), 'converted.csv', 'text/csv');
                }
            },
            'pdf-to-jpg': { 
                title: 'PDF to JPG', 
                desc: 'Convert PDF pages to JPG images.', 
                icon: '🖼️', 
                fileType: '.pdf', 
                multiple: false, 
                process: async (files) => {
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    if (pdf.numPages === 1) {
                        showLoader('Converting page to JPG...');
                        const canvas = await renderPdfPageToCanvas(pdf, 1);
                        canvas.toBlob(blob => createDownloadLink(blob, 'converted.jpg', 'image/jpeg'), 'image/jpeg', 0.9);
                    } else {
                        const zip = new JSZip();
                        for (let i = 1; i <= pdf.numPages; i++) {
                            showLoader(`Converting page ${i}/${pdf.numPages} to JPG...`);
                            const canvas = await renderPdfPageToCanvas(pdf, i);
                            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                            zip.file(`page_${i}.jpg`, blob);
                        }
                        showLoader('Creating ZIP file...');
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        createDownloadLink(zipBlob, 'converted_images.zip', 'application/zip');
                    }
                }
            },
            'pdf-to-ppt': {
                title: 'PDF to PowerPoint',
                desc: 'Convert each page of a PDF into an image on a PowerPoint slide.',
                icon: '📊',
                fileType: '.pdf',
                multiple: false,
                process: async (files) => {
                    const pres = new PptxGenJS();
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        showLoader(`Converting page ${i}/${pdf.numPages} to slide...`);
                        const canvas = await renderPdfPageToCanvas(pdf, i, 2);
                        const dataUrl = canvas.toDataURL('image/png');
                        
                        const slide = pres.addSlide();
                        slide.addImage({ data: dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                    }
                    
                    await pres.writeFile({ fileName: 'converted.pptx' });
                    hideLoader();
                }
            },
            'pdf-to-word': {
                title: 'PDF to Word',
                desc: 'Convert PDF to an editable DOCX file. Complex layouts may vary.',
                icon: '📄',
                fileType: '.pdf',
                multiple: false,
                process: async (files) => {
                    const docChildren = [];
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        showLoader(`Analyzing page ${i}/${pdf.numPages}...`);
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        
                        const lines = new Map();
                        for (const item of textContent.items) {
                            if (!item.str.trim()) continue;
                            const y = Math.round(item.transform[5]);
                            if (!lines.has(y)) lines.set(y, []);
                            lines.get(y).push({ x: item.transform[4], text: item.str });
                        }
                        
                        const sortedLines = [...lines.entries()].sort((a, b) => b[0] - a[0]);
                        
                        for (const [, lineItems] of sortedLines) {
                            lineItems.sort((a, b) => a.x - b.x);
                            const lineText = lineItems.map(item => item.text).join(' ');
                            if (lineText.trim()) {
                                docChildren.push(new window.docx.Paragraph({ children: [new window.docx.TextRun(lineText)] }));
                            }
                        }
                    }

                    if(docChildren.length === 0) {
                        throw new Error("Could not extract any text from this PDF. It might be an image-only PDF. Try using the OCR PDF tool first.");
                    }

                    const doc = new window.docx.Document({ sections: [{ properties: {}, children: docChildren }] });
                    showLoader('Generating DOCX file...');
                    const blob = await window.docx.Packer.toBlob(doc);
                    createDownloadLink(blob, 'converted.docx', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                }
            },
            'png-to-pdf': { 
                title: 'PNG to PDF', 
                desc: 'Convert PNG images to a PDF file.', 
                icon: '🖼️', 
                fileType: '.png', 
                multiple: true,
                process: async (files) => {
                    const pdf = await PDFLib.PDFDocument.create();
                    for (const [i, file] of files.entries()) {
                        showLoader(`Adding image ${i+1}/${files.length}...`);
                        const imgBytes = await file.arrayBuffer();
                        const image = await pdf.embedPng(imgBytes);
                        const page = pdf.addPage([image.width, image.height]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                    }
                    const pdfBytes = await pdf.save();
                    createDownloadLink(pdfBytes, 'from_png.pdf', 'application/pdf');
                }
            },
            'protect-pdf': { 
                title: 'Protect PDF', 
                desc: 'Add a password to protect your PDF.', 
                icon: '🔒', 
                fileType: '.pdf', 
                multiple: false,
                options: () => `<label for="pdf-password">New Password:</label><input type="password" id="pdf-password" class="options-input">`,
                process: async (files, options) => {
                    const password = options['pdf-password'];
                    if (!password) throw new Error('Password is required.');
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                    const protectedBytes = await pdf.save({ userPassword: password });
                    createDownloadLink(protectedBytes, 'protected.pdf', 'application/pdf');
                }
            },
            'rotate-pdf': {
                title: 'Rotate PDF',
                desc: 'Rotate all pages of a PDF file.',
                icon: '🔄',
                fileType: '.pdf',
                multiple: false,
                options: () => `
                    <label for="rotate-angle">Rotation Angle:</label>
                    <select id="rotate-angle">
                        <option value="90">90° Clockwise</option>
                        <option value="180">180°</option>
                        <option value="270">270° Clockwise</option>
                    </select>`,
                process: async (files, options) => {
                    const angle = parseInt(options['rotate-angle']);
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                    pdf.getPages().forEach(page => page.setRotation(PDFLib.degrees((page.getRotation().angle + angle) % 360)));
                    const rotatedPdfBytes = await pdf.save();
                    createDownloadLink(rotatedPdfBytes, 'rotated.pdf', 'application/pdf');
                }
            },
            'sign-pdf': {
                title: 'Sign PDF',
                desc: 'Draw your signature and apply it to a PDF.',
                icon: '✍️',
                fileType: '.pdf',
                multiple: false,
                options: () => `
                    <p>Draw your signature in the box below:</p>
                    <div id="sign-canvas-container" style="display: inline-block;"><canvas id="sign-canvas"></canvas></div><br>
                    <button id="clear-sign-btn" class="btn" style="margin-top: 10px;">Clear</button>`,
                onFileSelect: () => {
                    const signCanvasEl = document.getElementById('sign-canvas');
                    fabricCanvas = new fabric.Canvas(signCanvasEl, { isDrawingMode: true, width: 400, height: 200, backgroundColor: '#fff' });
                    fabricCanvas.freeDrawingBrush.width = 3;
                    fabricCanvas.freeDrawingBrush.color = '#000000';
                    document.getElementById('clear-sign-btn').onclick = () => fabricCanvas.clear();
                },
                process: async (files) => {
                    if (fabricCanvas.isEmpty()) throw new Error('Please draw a signature first.');
                    const signatureDataUrl = fabricCanvas.toDataURL({ format: 'png' });
                    const signatureBytes = await fetch(signatureDataUrl).then(res => res.arrayBuffer());
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                    const signatureImage = await pdf.embedPng(signatureBytes);
                    const firstPage = pdf.getPages()[0];
                    const signatureDims = signatureImage.scale(0.25);
                    firstPage.drawImage(signatureImage, {
                        x: firstPage.getWidth() - signatureDims.width - 50,
                        y: 50,
                        width: signatureDims.width,
                        height: signatureDims.height,
                    });
                    const signedPdfBytes = await pdf.save();
                    createDownloadLink(signedPdfBytes, 'signed.pdf', 'application/pdf');
                }
            },
            'split-pdf': {
                title: 'Split PDF',
                desc: 'Extract specific pages from a PDF file.',
                icon: '✂️',
                fileType: '.pdf',
                multiple: false,
                options: () => `<label for="page-range">Page ranges (e.g., 1-3, 5, 7-9):</label><input type="text" id="page-range" class="options-input" placeholder="e.g., 1-3, 5, 7-9">`,
                process: async (files, options) => {
                    const pageRanges = options['page-range'];
                    if (!pageRanges) throw new Error('Page range is required.');
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
                    const newPdf = await PDFLib.PDFDocument.create();
                    
                    const pagesToExtract = new Set();
                    pageRanges.split(',').forEach(range => {
                        range = range.trim();
                        if (range.includes('-')) {
                            const [start, end] = range.split('-').map(Number);
                            for (let i = start; i <= end; i++) pagesToExtract.add(i - 1);
                        } else if(range) {
                            pagesToExtract.add(Number(range) - 1);
                        }
                    });
                    
                    const validPages = Array.from(pagesToExtract).filter(p => p >= 0 && p < pdf.getPageCount());
                    if (validPages.length === 0) throw new Error('Invalid or empty page range.');

                    const copiedPages = await newPdf.copyPages(pdf, validPages);
                    copiedPages.forEach(page => newPdf.addPage(page));

                    const newPdfBytes = await newPdf.save();
                    createDownloadLink(newPdfBytes, 'split.pdf', 'application/pdf');
                }
            },
            'unlock-pdf': { 
                title: 'Unlock PDF', 
                desc: 'Remove password from a PDF (password required).', 
                icon: '🔓', 
                fileType: '.pdf', 
                multiple: false,
                options: () => `<label for="pdf-password">PDF Password:</label><input type="password" id="pdf-password" class="options-input">`,
                process: async (files, options) => {
                    const password = options['pdf-password'];
                    if (!password) throw new Error('Password is required.');
                    showLoader('Attempting to unlock PDF...');
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes, { password });
                    const unlockedBytes = await pdf.save();
                    createDownloadLink(unlockedBytes, 'unlocked.pdf', 'application/pdf');
                }
            },
            'watermark-pdf': {
                title: 'Watermark PDF',
                desc: 'Add a text watermark to every page of a PDF.',
                icon: '💧',
                fileType: '.pdf',
                multiple: false,
                options: () => `
                    <label for="watermark-text">Watermark Text:</label>
                    <input type="text" id="watermark-text" class="options-input" placeholder="e.g., CONFIDENTIAL">
                    <label for="watermark-opacity">Opacity:</label>
                    <input type="range" id="watermark-opacity" min="0.1" max="1.0" step="0.1" value="0.5">`,
                process: async (files, options) => {
                    const text = options['watermark-text'];
                    if (!text) throw new Error('Watermark text is required.');
                    const opacity = parseFloat(options['watermark-opacity']);
                    const pdfBytes = await files[0].arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                    const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
                    
                    for (const page of pdf.getPages()) {
                        const { width, height } = page.getSize();
                        const textSize = Math.min(width, height) / 10;
                        page.drawText(text, {
                            x: width / 2 - (font.widthOfTextAtSize(text, textSize) / 2),
                            y: height / 2,
                            font, size: textSize, color: PDFLib.rgb(0.5, 0.5, 0.5), opacity: opacity, rotate: PDFLib.degrees(45),
                        });
                    }
                    const watermarkedPdfBytes = await pdf.save();
                    createDownloadLink(watermarkedPdfBytes, 'watermarked.pdf', 'application/pdf');
                }
            },
            'word-to-pdf': {
                title: 'Word to PDF',
                desc: 'Convert DOCX files to PDF format.',
                icon: '📝',
                fileType: '.docx',
                multiple: false,
                process: async (files) => {
                    try {
                        showLoader('Converting DOCX to HTML...');
                        const arrayBuffer = await files[0].arrayBuffer();
                        const { value: html } = await mammoth.convertToHtml({ arrayBuffer });
                        
                        showLoader('Generating PDF from HTML...');
                        const element = document.createElement('div');
                        element.style.padding = '20px';
                        element.innerHTML = html;
                        document.body.appendChild(element);
                        
                        await html2pdf().set({margin: 1, filename: 'word.pdf', pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }}).from(element).save();
                        
                        document.body.removeChild(element);
                        hideLoader();
                    } catch (err) {
                        console.error("Word to PDF conversion failed:", err);
                        throw new Error("Could not convert this Word file. It might be corrupted or in an unsupported format.");
                    }
                }
            },
        };
        
        // --- THEME LOGIC ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            themeToggle.checked = theme === 'dark';
            localStorage.setItem('theme', theme);
        }
        themeToggle.addEventListener('change', () => {
            applyTheme(themeToggle.checked ? 'dark' : 'light');
        });
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

        // --- UI Initialization ---
        function initializeUI() {
            const sortedToolKeys = Object.keys(toolImplementations).sort((a, b) => toolImplementations[a].title.localeCompare(toolImplementations[b].title));

            sortedToolKeys.forEach((key, index) => {
                const tool = toolImplementations[key];
                const card = document.createElement('div');
                card.className = 'tool-card reveal';
                card.dataset.tool = key;
                card.innerHTML = `
                    <div class="icon">${tool.icon}</div>
                    <h3>${tool.title}</h3>
                    <p>${tool.desc}</p>
                    ${index < 6 ? '<div class="badge">Popular</div>' : ''}
                `;
                card.addEventListener('click', () => openModal(key));
                toolsGrid.appendChild(card);
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        // --- MODAL, FILE HANDLING, PROCESSING, ETC. ---
        function openModal(toolId) {
            currentTool = toolId;
            const tool = toolImplementations[toolId];
            modalTitle.textContent = tool.title;
            fileInput.accept = tool.fileType;
            fileInput.multiple = tool.multiple || false;
            toolOptionsContainer.innerHTML = tool.options ? tool.options() : '';
            toolOptionsContainer.style.display = tool.options ? 'block' : 'none';
            if (tool.onFileSelect) {
                setTimeout(() => {
                    if (toolId === 'edit-pdf') {
                        document.getElementById('add-text-btn').onclick = addTextToCanvas;
                        document.getElementById('add-rect-btn').onclick = addRectToCanvas;
                        document.getElementById('draw-mode-btn').onclick = toggleDrawMode;
                        document.getElementById('prev-page').onclick = () => changePdfPage(-1);
                        document.getElementById('next-page').onclick = () => changePdfPage(1);
                    }
                }, 100);
            }
            modal.classList.add('active');
        }

        function closeModal() { modal.classList.remove('active'); resetModal(); }

        function resetModal() {
            currentTool = null;
            selectedFiles = [];
            updateFileList();
            outputArea.innerHTML = '';
            toolOptionsContainer.innerHTML = '';
            toolOptionsContainer.style.display = 'none';
            processBtn.disabled = true;
            fileInput.value = '';
            if (fabricCanvas) { fabricCanvas.dispose(); fabricCanvas = null; }
            pdfDoc = null; currentPage = 1; editStates = {};
        }
        
        function validateOptions() {
            if (selectedFiles.length === 0) {
                processBtn.disabled = true;
                return;
            }
            let allOptionsValid = true;
            const inputs = toolOptionsContainer.querySelectorAll('.options-input');
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    allOptionsValid = false;
                }
            });
            processBtn.disabled = !allOptionsValid;
        }
        
        function handleFiles(files) {
            const tool = toolImplementations[currentTool];
            const allowedTypes = tool.fileType.split(',');
            const newFiles = [...files].filter(file => allowedTypes.some(type => file.name.toLowerCase().endsWith(type.trim())));

            if (newFiles.length === 0) { showError(`Please select valid ${tool.fileType} file(s).`); return; }
            if (tool.multiple) selectedFiles.push(...newFiles); else selectedFiles = [newFiles[0]];
            
            updateFileList();
            if (tool.onFileSelect) tool.onFileSelect(selectedFiles[0]);
        }
        
        function updateFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-list-item';
                li.innerHTML = `<span>${file.name}</span><button class="remove-file-btn" data-index="${index}">&times;</button>`;
                fileList.appendChild(li);
            });
            validateOptions();
        }

        async function processFiles() {
            const tool = toolImplementations[currentTool];
            if (!tool) return;
            const options = {};
            toolOptionsContainer.querySelectorAll('input, select, textarea').forEach(input => { options[input.id] = input.value; });
            showLoader('Starting process...');
            try {
                outputArea.innerHTML = '';
                await tool.process(selectedFiles, options);
            } catch (error) {
                console.error(error);
                showError(`An error occurred: ${error.message}`);
            } finally {
                if (!['pdf-to-ppt', 'word-to-pdf', 'excel-to-pdf', 'html-to-pdf'].includes(currentTool)) {
                    hideLoader();
                }
            }
        }
        
        function showLoader(text) { loaderText.innerHTML = text; loader.style.display = 'flex'; }
        function hideLoader() { loader.style.display = 'none'; }
        function showError(message) { alert(message); }
        function createDownloadLink(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.textContent = `Download ${filename}`;
            outputArea.appendChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 60000);
        }
        
        window.deletePageThumbnail = (btn) => btn.closest('.page-thumbnail').remove();
        window.rotatePageThumbnail = (btn) => {
            const thumb = btn.closest('.page-thumbnail');
            const canvas = thumb.querySelector('canvas');
            const currentRotation = parseInt(thumb.dataset.rotation || '0');
            const newRotation = (currentRotation + 90) % 360;
            thumb.dataset.rotation = newRotation;
            canvas.style.transform = `rotate(${newRotation}deg)`;
        };
        
        async function renderPdfPageForEditing(pageNum) {
            if (!pdfDoc || pageNum < 1 || pageNum > pdfDoc.numPages) return;
            if (fabricCanvas) editStates[currentPage] = fabricCanvas.toObject();
            currentPage = pageNum;
            showLoader(`Rendering page ${pageNum}...`);
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1 });
            const pdfCanvas = document.getElementById('pdf-canvas');
            const fabricCanvasEl = document.getElementById('fabric-canvas');
            const container = document.getElementById('edit-canvas-container');
            pdfCanvas.width = fabricCanvasEl.width = viewport.width;
            pdfCanvas.height = fabricCanvasEl.height = viewport.height;
            container.style.width = `${viewport.width}px`; container.style.height = `${viewport.height}px`;
            await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: viewport }).promise;
            if (!fabricCanvas) fabricCanvas = new fabric.Canvas('fabric-canvas');
            fabricCanvas.clear();
            if (editStates[currentPage]) fabricCanvas.loadFromJSON(editStates[currentPage]);
            fabricCanvas.renderAll();
            document.getElementById('page-num').textContent = `Page ${pageNum} of ${pdfDoc.numPages}`;
            document.getElementById('prev-page').disabled = pageNum <= 1;
            document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
            hideLoader();
        }
        async function changePdfPage(delta) { await renderPdfPageForEditing(currentPage + delta); }
        function addTextToCanvas() { if (fabricCanvas) fabricCanvas.add(new fabric.IText('Sample Text', { left: 50, top: 50, fill: 'red', fontSize: 24 })); }
        function addRectToCanvas() { if (fabricCanvas) fabricCanvas.add(new fabric.Rect({ left: 100, top: 100, fill: 'rgba(255,0,0,0.5)', width: 100, height: 100, stroke: 'red', strokeWidth: 2 })); }
        function toggleDrawMode(e) { if (fabricCanvas) { fabricCanvas.isDrawingMode = !fabricCanvas.isDrawingMode; e.target.textContent = fabricCanvas.isDrawingMode ? 'Exit Draw' : 'Draw'; } }

        // --- EVENT LISTENERS ---
        window.addEventListener('scroll', () => header.classList.toggle('scrolled', window.scrollY > 50));
        hamburger.addEventListener('click', () => { hamburger.classList.toggle('active'); navMenu.classList.toggle('active'); });
        navMenu.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', () => { hamburger.classList.remove('active'); navMenu.classList.remove('active'); }));
        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        fileList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-file-btn')) { selectedFiles.splice(parseInt(e.target.dataset.index), 1); updateFileList(); } });
        processBtn.addEventListener('click', processFiles);
        toolOptionsContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('options-input')) {
                validateOptions();
            }
        });

        // --- Run Initialization ---
        initializeUI();
    });
    </script>
</body>
</html>